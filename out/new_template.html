<!doctype html>
<html lang="en-us">
  <head>
    <meta http-equiv="origin-trial" content="AiiqErPPIECW3smg0ZrmkBorbURWiOcf1tn4ge/XORQdLjo8OK+lM8WgWT8fDh905BmSi9he8uji55p/rnf1UgUAAABseyJvcmlnaW4iOiJodHRwczovL3NoYWRlcmVkaXRvci5rYXVzdC5lZHUuc2E6NDQzIiwiZmVhdHVyZSI6IldlYkdQVSIsImV4cGlyeSI6MTY2MzcxODM5OSwiaXNTdWJkb21haW4iOnRydWV9">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"/>
    <title>shader editor</title>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
    <!-- jQuery  -->
    <script src="https://fastly.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js" integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ" crossorigin="anonymous"></script>
    <!-- load bootstrap -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="CodeMirror/lib/codemirror.css">
    <script src="CodeMirror/lib/codemirror.js"></script>
    <link rel=stylesheet href="CodeMirror/theme/eclipse.css">
    <script src="CodeMirror/addon/edit/matchbrackets.js"></script> 
    <style>
        body { margin: 0; background-color: rgba(110, 109, 109, 0.432) }
        .emscripten {
            position: absolute;
            top: 10%;
            left: 3%;
            margin: 0px;
            border: 0;
            width: 45%;
            height: 50%;
            overflow: hidden;
            display: block;
            image-rendering: optimizeSpeed;
            image-rendering: -moz-crisp-edges;
            image-rendering: -o-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            -ms-interpolation-mode: nearest-neighbor;
        }
        .textbox
        {
          position: absolute;
          top: 10%;
          left: 55%;
          width: 40%;
        }

        .popover
        {
          max-width: 600px;
        }
        .description
        {
          position: relative;
          width: 100%;
          height: 5%;
          background-color: white;
        }
        .display_desc
        {
          display: none;
        }
        .texture_image
        {
          position: absolute;
          top: 100%;
          left: 0%;
          width: 70%;
        }
        .upload_texture
        {
          position: absolute;
          top: 100%;
          left: 70%;
          width: 40%;
        }
        .save_part
        {
          position: absolute;
          top: 65%;
          left: 5%;
          width: 20%; 
        }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-static-top" >
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">Shader Editor</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a href="/">Home</a></li>
                <li><a href="/about">About</a></li>
                <li><a href="/contact">Contact</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                  <li><a id="welcome"></a></li>
                <li><a href="/browse">Browse</a></li>
                <li><a href="/new">New</a></li>
                <li><a id="signin" href="/signin">Sign In</a></li>
                </ul>
        </div>
      </div>
    </nav>
    <div class="container">
      <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
      <div class="save_part" id="save_part" >
        <div class="form-group">
          <label for="save_name">Name of the shader</label>
          <input  type="text" class="form-control" id="save_name" value="{{shadername}}">
        </div>
        <div class="form-group">
          <label for="save_select">Example select</label>
          <select class="form-control" id="save_select" >
            <option>Private</option>
            <option>Public</option>
          </select>
        </div>
        <button  class="btn btn-primary" onclick="save()">Save</button>
      </div>
      <div class="textbox">
        <div class="description" onclick="toggle('display_desc')">
          <span class="glyphicon glyphicon-menu-down" aria-hidden="true" >Input</span>
          <p class="display_desc" id="display_desc">
            uniform Time : f32; //shader playback time (in seconds) <br> 
            uniform Resolution : vec3&lt;f32&gt;; // viewport resolution <br> 
            uniform Mouse : vec4&lt;f32&gt;; // mouse pixel coords. xy: current, zw: click <br> 
            uniform Date1 : vec3&lt;i32&gt;; // year, month, day <br> 
            uniform Date2 : vec3&lt;i32&gt;; // hour, minute, second <br> 
            var texture1..4: texture_2d&lt;f32&gt;; // input textures <br> 
            var sampler_: sampler; // input sampler <br>
          </p>
        </div>
        <form action="compile" method="post">
        <p>
        <textarea id="code" name="code" rows="25" cols="70">{{wgsl_code}}</textarea>
    </p>
    <input type="hidden" name="texture1" id="texture1" value={{texture1}}>
    <input type="hidden" name="texture2" id="texture2" value={{texture2}}>
    <input type="hidden" name="texture3" id="texture3" value={{texture3}}>
    <input type="hidden" name="texture4" id="texture4" value={{texture4}}>
    <button type="submit" class="btn btn-primary"  >Compile</button>
    </form>
    
    <br>
    <br>
    <div class="texture_image">
    <button id="popover1" type="button" class="btn btn-default" title="Texture 1" trigger="click"
        data-container="body" data-toggle="popover1" data-placement="top" 
        >
      texture_1
    </button>
    <button id="popover2" type="button" class="btn btn-default" title="Texture 2"  
        data-container="body" data-toggle="popover2" data-placement="top" 
        >
        texture_2
    </button>
    <button id="popover3" type="button" class="btn btn-default" title="Texture 3"  
        data-container="body" data-toggle="popover3" data-placement="top" 
        >
        texture_3
    </button>
    <button id="popover4" type="button" class="btn btn-default" title="Texture 4"  
        data-container="body" data-toggle="popover4" data-placement="top" 
        >
        texture_4
    </button>
    <br>
    <img id="img1" src="/texture/{{texture1}}" class="img-thumbnail" width="84" height="84">
    <img id="img2" src="/texture/{{texture2}}" class="img-thumbnail" width="84" height="84">
    <img id="img3" src="/texture/{{texture3}}" class="img-thumbnail" width="84" height="84">
    <img id="img4" src="/texture/{{texture4}}" class="img-thumbnail" width="84" height="84">
    </div>
    <div class="upload_texture" id="upload_texture">
      <label for="image">Upload Texture</label>
      <input type="file" class="form-control-file" id="image" name="image" accpet=".jpg .png">
      <br>
      <button  class="btn btn-primary" onclick="upload()">Upload</button>
    </div>
    </div>  
    </div>
    
    <script>
      $(function (){
          $("[data-toggle='popover1']").popover(
            { html: true,
              content: function() {
                return content("\"texture1\"","\"img1\"");
              }
            }
          );
          $("[data-toggle='popover2']").popover(
            { html: true,
              content: function() {
                return content("\"texture2\"","\"img2\"");
              }
            }
          );
          $("[data-toggle='popover3']").popover(
            { html: true,
              content: function() {
                return content("\"texture3\"","\"img3\"");
              }
            }
          );
          $("[data-toggle='popover4']").popover(
            { html: true,
              content: function() {
                return content("\"texture4\"","\"img4\"");
              }
            }
          );
      });
      function htmlDecode (text){
      var temp = document.createElement("div");
      temp.innerHTML = text;
      var output = temp.innerText || temp.textContent;
        temp = null;
        return output;
      }
      var global_popover_code="{{texture_code}}"
      var whether_decode=true
      function  content(texturenum,imgnum)  {    
      var  code=global_popover_code
      if(whether_decode)
      {code=htmlDecode(code)}
      code=code.replace(/texturenum/g,texturenum).replace(/imgnum/g,imgnum);
      var  data  =  $(code); 
      return  data;  
      } 
      function click_texture(texture,image,image_name)
      {
        document.getElementById(texture).value=image_name;
        document.getElementById(image).src="texture/"+image_name;
        document.getElementById("popover"+image[3]).click();
      }
      function toggle(targetid){
      if (document.getElementById){
        target=document.getElementById(targetid);
            if (target.style.display=="block"){
                target.style.display="none";
            } else {
                target.style.display="block";
            }
      }}
      function isAssetTypeAnImage(ext) {
  return (['png', 'jpg', 'jpeg', 'bmp'].indexOf(ext.toLowerCase()) !== -1)
  }
  function upload(){
      el=document.getElementById("image")
      var files = el.files[0]
      if (files!= undefined)
      {
      var index= files.name.lastIndexOf(".");
      var ext = files.name.substr(index+1);
      }
      //console.log(files.name)
      var formDate = new FormData()
      formDate.set("image",files)
      if (files!= undefined)
      {
        if(isAssetTypeAnImage(ext)==true)
        {$.ajax({
          url: '/file_upload',
          data: formDate,
          type: 'post',
          contentType: false,
          processData: false,
          success: function(res){
              global_popover_code=res;
              whether_decode=false
              alert("upload successfully.")
          }
        })}
        else
        {
          alert("Now we just support .png .jpg .jpeg .bmp")
        }
      }
      else
      {
        alert("please select an image.")
      }
  } 

  function save(){
      var code=document.getElementById("code").value
      var name=document.getElementById('save_name').value
      var status=document.getElementById('save_select').value
      var formDate = new FormData()
      formDate.set("code",code)
      formDate.set("name",name)
      formDate.set("texture1",document.getElementById("texture1").value)
      formDate.set("texture2",document.getElementById("texture2").value)
      formDate.set("texture3",document.getElementById("texture3").value)
      formDate.set("texture4",document.getElementById("texture4").value)
      formDate.set("status",status)
      
      if (name!= undefined)
      {
        $.ajax({
          url: '/save_shader',
          data: formDate,
          type: 'post',
          contentType: false,
          processData: false,
          success: function(res){
              alert(res)
          }
        })

      }
  } 
    </script>
 
    <script type='text/javascript'>
      var Module;
      (async () => {
        Module = {
          preRun: [],
          postRun: [],
          print: (function() {
              return function(text) {
                  text = Array.prototype.slice.call(arguments).join(' ');
                  console.log(text);
              };
          })(),
          printErr: function(text) {
              text = Array.prototype.slice.call(arguments).join(' ');
              console.error(text);
          },
          canvas: (function() {
              var canvas = document.getElementById('canvas');
  
              return canvas;
          })(),
          setStatus: function(text) {
              console.log("status: " + text);
          },
          monitorRunDependencies: function(left) {
              // no run dependencies to log
          }
        };
        window.onerror = function() {
          console.log("onerror: " + event);
        };

      // Initialize the graphics adapter
      {
          const adapter = await navigator.gpu.requestAdapter();
          const device = await adapter.requestDevice();
          Module.preinitializedWebGPUDevice = device;
      }

      {
          const js = document.createElement('script');
          js.async = true;
          js.src = "new_template.js";
          document.body.appendChild(js);
      }
      })();
      if("{{username}}".length!=0)
      {
        document.getElementById("signin").href="/logout";
        document.getElementById("signin").innerText="Log Out";
        document.getElementById("welcome").href="/userprofile";
        document.getElementById("welcome").innerText="Welcome,{{username}}";
        document.getElementById("save_part").hidden=false;
        document.getElementById("upload_texture").hidden=false;
      }
      else
      {
        document.getElementById("save_part").hidden=true;
        document.getElementById("upload_texture").hidden=true;
      }
    </script>
  </body>
</html>